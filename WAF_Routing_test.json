{
    "$schema": "https://raw.githubusercontent.com/F5Networks/f5-appsvcs-extension/main/schema/latest/as3-schema.json",
    "class": "AS3",
    "action": "deploy",
    "persist": true,
    "declaration": {
        "class": "ADC",
        "schemaVersion": "3.0.0",
        "id": "WAF_Routing",
        "label": "WAF_Routing",
        "WAF_Routing": {
            "class": "Tenant",
            "WAF_Routing": {
                "class": "Application",
                "vs_https": {
                    "class": "Service_HTTPS",
                    "virtualAddresses": [
                        "192.168.57.73"
                    ],
                    "redirect80": true,
                    "persistenceMethods": [],
                    "profileHTTP": {
                        "use": "pr_http_xff"
                    },
                    "serverTLS": {
                        "bigip": "/Common/clientssl"
                    },
                    "iRules": [{
                        "use": "rule_http_contentswitching"
                    }],
                    "policyWAF": {
                        "bigip": "/Common/minimalistic_waf"
                    },
                    "securityLogProfiles": [
                        {"bigip": "/Common/Log all requests"}
                    ]
                },
                "pr_http_xff": {
                    "class": "HTTP_Profile",
                    "xForwardedFor": true
                }                ,
                "pool_ltm-demo_http_red": {
                    "class": "Pool",
                    "loadBalancingMode": "round-robin",
                    "members": [
                        {
                            "servicePort": 8000,
                            "serverAddresses": [
                                "10.0.2.71"
                            ],  
                            "shareNodes": true
                        }
                    ],
                    "monitors": ["http"]
                },
                "pool_ltm-demo_http_blue": {
                    "class": "Pool",
                    "loadBalancingMode": "round-robin",
                    "members": [
                        {
                            "servicePort": 8000,
                            "serverAddresses": [
                                "10.0.2.72"
                            ],  
                            "shareNodes": true
                        }
                    ],
                    "monitors": ["http"]
                },
                "pool_ltm-demo_http_green": {
                    "class": "Pool",
                    "loadBalancingMode": "round-robin",
                    "members": [
                        {
                            "servicePort": 8000,
                            "serverAddresses": [
                                "10.0.2.73"
                            ],  
                            "shareNodes": true
                        }
                    ],
                    "monitors": ["http"]
                },
                "rule_http_contentswitching": {
                    "class": "iRule",
                    "iRule": {
                        "base64": "d2hlbiBIVFRQX1JFUVVFU1QgcHJpb3JpdHkgNTAwIHsKICAgIGlmIHtbSFRUUDo6aGFzX3Jlc3BvbmRlZF19IHsKICAgICAgICByZXR1cm4KICAgIH0gZWxzZSB7CiAgICAgICAgIyBzZXQgcG9vbCBiYXNlZCBvbiBob3N0IGhlYWRlciB3aXRoIGVycm9yIGhhbmRsaW5nCiAgICAgICAgY2F0Y2ggewogICAgICAgICAgICBpZiB7W2NsYXNzIG1hdGNoIFtzdHJpbmcgdG9sb3dlciBbSFRUUDo6aG9zdF1dIGVxdWFscyAvV0FGX1JvdXRpbmdfTFNJL1dBRl9Sb3V0aW5nX0xTSS9kZ19jb250ZW50X3N3aXRjaGluZ119IHsKICAgICAgICAgICAgICAgIEFTTTo6ZW5hYmxlIC9Db21tb24vcG9saWN5X3RlbXBsYXRlX2xzaQogICAgICAgICAgICAgICAgcG9vbCBbY2xhc3MgbWF0Y2ggLXZhbHVlIFtzdHJpbmcgdG9sb3dlciBbSFRUUDo6aG9zdF1dIGVxdWFscyAvV0FGX1JvdXRpbmdfTFNJL1dBRl9Sb3V0aW5nX0xTSS9kZ19jb250ZW50X3N3aXRjaGluZ10KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHBvb2wgIi9XQUZfUm91dGluZ19MU0kvV0FGX1JvdXRpbmdfTFNJL3Bvb2xfbHRtLWRlbW9faHR0cF9ncmVlbiIKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQ=="
                    }
                },                
                "dg_content_switching":{
                    "class": "Data_Group",
                    "storageType": "internal",
                    "keyDataType": "string",
                    "records": [
                        {
                            "key": "red.appsec.rocks",
                            "value": "/WAF_Routing/WAF_Routing/pool_ltm-demo_http_red"
                        },
                        {
                            "key": "blue.appsec.rocks",
                            "value": "/WAF_Routing/WAF_Routing/pool_ltm-demo_http_blue"
                        }
                    ]
                }
            }
        }
    }
}